local module = {}

--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--// Player
local LocalPlayer = Players.LocalPlayer

--// Utilities
local function FWait(t)
    local s = tick()
    repeat RunService.Heartbeat:Wait() until tick() - s >= (t or 0)
end

--// Fling
function module:fling(Target)
    if not (Target and Target:IsA("Player")) then return end

    local Character = LocalPlayer.Character
    local TargetCharacter = Target.Character
    if not (Character and TargetCharacter) then return end

    local RootPart = Character:FindFirstChild("HumanoidRootPart")
    local Humanoid = Character:FindFirstChildOfClass("Humanoid")
    local TargetRoot = TargetCharacter:FindFirstChild("HumanoidRootPart")
    local TargetHumanoid = TargetCharacter:FindFirstChildOfClass("Humanoid")
    if not (RootPart and Humanoid and TargetHumanoid) then return end

    Character.PrimaryPart = RootPart
    local OldCFrame = RootPart.CFrame
    local OldFPDH = workspace.FallenPartsDestroyHeight

    workspace.CurrentCamera.CameraSubject = TargetCharacter

    local function ForcePosition(BasePart, Offset, Angle)
        if not (BasePart and BasePart:IsA("BasePart")) then return end
        if not (Character and Character.PrimaryPart) then return end
        Character:SetPrimaryPartCFrame(CFrame.new(BasePart.Position) * Offset * Angle)
        RootPart.Velocity = Vector3.new(9e9,9e9,9e9)
        RootPart.RotVelocity = Vector3.new(9e9,9e9,9e9)
    end

local function ForceBasePart(BasePart)
    if not (BasePart and BasePart:IsA("BasePart")) then return end
    if not TargetHumanoid then return end

    local Start = tick()
    local Duration = 3.5
    local Angle = 0

    while tick() - Start < Duration do
        if not (Humanoid and Humanoid.Health > 0) then break end
        if not (RootPart and RootPart.Parent) then break end
        if not (BasePart.Parent == TargetCharacter) then break end
        if not BasePart:IsDescendantOf(workspace) then break end

        local vel = 0
        if BasePart.AssemblyLinearVelocity then
            vel = BasePart.AssemblyLinearVelocity.Magnitude
        end

        Angle += 100
        local offset = TargetHumanoid.MoveDirection * (vel / 2)

        if RootPart and Character.PrimaryPart then
            Character:SetPrimaryPartCFrame(CFrame.new(BasePart.Position) * (CFrame.new(0,3,0) + offset) * CFrame.Angles(0,0,math.rad(Angle)))
            RootPart.Velocity = Vector3.new(9e9,9e9,9e9)
            RootPart.RotVelocity = Vector3.new(9e9,9e9,9e9)
            Character:SetPrimaryPartCFrame(CFrame.new(BasePart.Position) * (CFrame.new(0,-3,0) + offset) * CFrame.Angles(0,0,math.rad(Angle)))
            RootPart.Velocity = Vector3.new(9e9,9e9,9e9)
            RootPart.RotVelocity = Vector3.new(9e9,9e9,9e9)
        end

        FWait()
        if vel > 1000 then break end
    end
end

    --// Prep
    workspace.FallenPartsDestroyHeight = 0/0
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,false)
    if Character:FindFirstChild("Animate") then Character.Animate.Disabled = true end

    local BV = Instance.new("BodyVelocity")
    BV.MaxForce = Vector3.new(math.huge,math.huge,math.huge)
    BV.Velocity = Vector3.new(9e9,9e9,9e9)
    BV.Parent = RootPart

    --// Execute
    ForceBasePart(TargetRoot or TargetCharacter:FindFirstChild("Head"))

    --// Cleanup
    BV:Destroy()
    Humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,true)
    workspace.CurrentCamera.CameraSubject = Character
    workspace.FallenPartsDestroyHeight = OldFPDH
    if Character:FindFirstChild("Animate") then Character.Animate.Disabled = false end

    for _,v in ipairs(Character:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Velocity = Vector3.zero
            v.RotVelocity = Vector3.zero
        end
    end

    Character:SetPrimaryPartCFrame(OldCFrame)
end

--// Emote
function module:emote(name)
    if not name then return end
    local r = ReplicatedStorage:FindFirstChild("Remotes")
    if r and r:FindFirstChild("Misc") and r.Misc:FindFirstChild("PlayEmote") then
        r.Misc.PlayEmote:Fire(name)
    end
end

return module
